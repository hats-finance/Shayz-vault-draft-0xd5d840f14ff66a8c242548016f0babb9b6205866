import { useContext, useState } from "react";
import { IVault } from "types";
import { useVaults } from "hooks/vaults/useVaults";
import { VulnerabilityFormContext } from "pages/VulnerabilityFormPage/store";
import SearchIcon from "assets/icons/search.icon";
import { Loading, Vault } from "components";
import "./index.scss";

export default function ProjectSelect() {
  const { vulnerabilityData, setVulnerabilityData } = useContext(VulnerabilityFormContext);
  const [userInput, setUserInput] = useState("");
  const { vaults: vaultsData } = useVaults();

  const handleSelectedProject = (vault: IVault) => {
    setVulnerabilityData((prev) => ({
      ...prev!,
      project: {
        verified: true,
        projectName: vault.description?.["project-metadata"].name!,
        projectId: vault.id,
        contractAddress: vault.master.address,
      },
      description: undefined,
      submission: undefined,
      terms: undefined,
    }));
  };

  const vaults = vaultsData?.map((vault: IVault, index: number) => {
    const projectName = vault.description?.["project-metadata"].name;
    if (projectName?.toLowerCase().includes(userInput.toLowerCase()) && !vault.liquidityPool && vault.registered) {
      return (
        <Vault
          key={index}
          vault={vault}
          expanded={false}
          onSelect={() => handleSelectedProject(vault)}
          selected={vulnerabilityData?.project?.projectId === vault.id}
        />
      );
    }
    return undefined;
  });

  return (
    <div className="project-select-wrapper">
      {!vaults ? (
        <Loading />
      ) : (
        <>
          <div className="search-wrapper">
            <SearchIcon />
            <input type="text" placeholder="Search or select project" onChange={(e) => setUserInput(e.target.value)} />
          </div>

          {vaults.every((value: any) => value === undefined) ? (
            <div className="no-results">No projects found</div>
          ) : (
            <div className="table-wrapper">
              <table>
                <tbody>
                  <tr className="onlyDesktop">
                    <th></th>
                    <th>PROJECT NAME</th>
                    <th>VAULT TOTAL</th>
                  </tr>
                  {vaults}
                </tbody>
              </table>
            </div>
          )}
        </>
      )}
    </div>
  );
}
