import DeleteIcon from "@mui/icons-material/DeleteOutlineOutlined";
import ExpandIcon from "@mui/icons-material/ExpandLess";
import CollapseIcon from "@mui/icons-material/ExpandMore";
import { Button, FormInput } from "components";
import { useEnhancedFormContext } from "hooks/form/useEnhancedFormContext";
import { useContext, useEffect, useState } from "react";
import { UseFieldArrayRemove, useWatch } from "react-hook-form";
import { useTranslation } from "react-i18next";
import { IEditedVaultDescription } from "types";
import { VaultEditorFormContext } from "../../../store";
import { StyledVulnerabilitySeverityForm } from "./styles";

type VulnerabilitySeverityFormProps = {
  index: number;
  severitiesCount: number;
  remove: UseFieldArrayRemove;
};

export default function VulnerabilitySeverityForm({ index, remove, severitiesCount }: VulnerabilitySeverityFormProps) {
  const { t } = useTranslation();

  const { register, control, getValues, setValue } = useEnhancedFormContext<IEditedVaultDescription>();

  const { allFormDisabled } = useContext(VaultEditorFormContext);

  const severities = useWatch({ control, name: "vulnerability-severities-spec.severities" });
  const severityName = useWatch({ control, name: `vulnerability-severities-spec.severities.${index}.name` });
  const [isExpanded, setIsExpanded] = useState(!severityName);
  const [showNftInfo, setShowNftInfo] = useState(!severityName || allFormDisabled);

  const maxBountyPercentage = useWatch({ control, name: "parameters.maxBountyPercentage" });
  const severityReward = useWatch({ control, name: `vulnerability-severities-spec.severities.${index}.percentage` });

  const viewOnDapp = `${(maxBountyPercentage * severityReward) / 100}%`;

  // Update severities options for usage in contracts covered
  useEffect(() => {
    const sevOpts = severities.map((sev) => ({ label: sev.name, value: sev.id }));
    const currentSevOpts = getValues("severitiesOptions");

    if (JSON.stringify(sevOpts) !== JSON.stringify(currentSevOpts)) {
      setValue("severitiesOptions", sevOpts);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [severities]);

  const isV1 = useWatch({ control, name: "version" }) === "v1";

  return (
    <StyledVulnerabilitySeverityForm expanded={isExpanded} showNftInfo={showNftInfo}>
      <div className="header" onClick={() => setIsExpanded((prev) => !prev)}>
        {isExpanded ? <CollapseIcon fontSize="large" /> : <ExpandIcon fontSize="large" />}
        <span>{severityName}</span>
      </div>

      <div className="severity">
        <div className="content">
          <div className="subcontent">
            <FormInput
              {...register(`vulnerability-severities-spec.severities.${index}.name`)}
              disabled={allFormDisabled}
              label={t("VaultEditor.severity-name")}
              colorable
              placeholder={t("VaultEditor.severity-name-placeholder")}
            />
            {isV1 ? (
              <FormInput
                {...register(`vulnerability-severities-spec.severities.${index}.index`, { valueAsNumber: true })}
                disabled={allFormDisabled}
                label={t("VaultEditor.severity-index")}
                colorable
                placeholder={t("VaultEditor.severity-index-placeholder")}
              />
            ) : (
              <div className="percentage-container">
                <FormInput
                  {...register(`vulnerability-severities-spec.severities.${index}.percentage`, { valueAsNumber: true })}
                  disabled={allFormDisabled}
                  label={t("VaultEditor.percentage-bounty")}
                  colorable
                  type="number"
                  min={0}
                  max={100}
                  noMargin
                  placeholder={t("VaultEditor.percentage-bounty-placeholder")}
                />

                <div className="calculations">
                  {severityReward}% x {maxBountyPercentage}% = <span>{viewOnDapp} (showed on dApp)</span>
                </div>
              </div>
            )}
          </div>

          <FormInput
            {...register(`vulnerability-severities-spec.severities.${index}.description`)}
            disabled={allFormDisabled}
            label={t("VaultEditor.severity-description")}
            rows={20}
            type="textarea"
            colorable
            name={`vulnerability-severities-spec.severities.${index}.description`}
            placeholder={t("VaultEditor.severity-description-placeholder")}
          />

          <div className="nft-section">
            <FormInput
              disabled={allFormDisabled}
              name={`showNftInfo.${index}`}
              checked={showNftInfo}
              type="toggle"
              label={t("editNft")}
              onChange={(e) => setShowNftInfo(e.target.checked)}
            />

            <div className="nft-info">
              <div className="half">
                <FormInput
                  {...register(`vulnerability-severities-spec.severities.${index}.nft-metadata.name`)}
                  disabled={allFormDisabled}
                  label={t("VaultEditor.nft-name")}
                  colorable
                  placeholder={t("VaultEditor.nft-name-placeholder")}
                />
              </div>

              <FormInput
                {...register(`vulnerability-severities-spec.severities.${index}.nft-metadata.description`)}
                disabled={allFormDisabled}
                label={t("VaultEditor.nft-description")}
                rows={2}
                type="textarea"
                colorable
                placeholder={t("VaultEditor.nft-description-placeholder")}
              />

              <div className="inputs">
                <FormInput
                  {...register(`vulnerability-severities-spec.severities.${index}.nft-metadata.image`)}
                  disabled={allFormDisabled}
                  label={t("VaultEditor.nft-image")}
                  pastable
                  colorable
                  placeholder={t("VaultEditor.nft-image-placeholder")}
                />

                <FormInput
                  {...register(`vulnerability-severities-spec.severities.${index}.nft-metadata.animation_url`)}
                  disabled={allFormDisabled}
                  label={t("VaultEditor.nft-animation")}
                  pastable
                  colorable
                  placeholder={t("VaultEditor.nft-animation-placeholder")}
                />
              </div>
            </div>
          </div>
        </div>

        {!allFormDisabled && severitiesCount > 1 && (
          <div className="controller-buttons">
            <Button styleType="outlined" filledColor="secondary" onClick={() => remove(index)}>
              <DeleteIcon className="mr-1" />
              <span>{t("removeSeverity")}</span>
            </Button>
          </div>
        )}
      </div>
    </StyledVulnerabilitySeverityForm>
  );
}
